% City_05_11_summer_avg_percent_change: attempts to reproduce what Ashley
% did in her 2012 paper in order to confirm that the decreasing trend is
% still supported with the v.3 of OMNO2.
%
% Josh Laughner <joshlaugh5@gmail.com> 19 May 2014


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%   USER INPUT VARS     %%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%List the city names, center lats, lons, and perimeters here.  Will iterate through
%these.
cities = {'Albuquerque NM', 35.20, -106.55, 30;...
    'Atlanta GA', 33.80, -84.35, 35;...
    'Bakersfield CA', 35.30, -119.00, 25;...
    'Boston MA', 42.45, -71.00, 30;...
    'Charlotte NC', 35.25, -80.85, 20;...
    'Chicago IL', 41.80, -87.70, 60;...
    'Cincinnati OH', 39.10, -84.55, 25;...
    'Cleveland OH', 41.45, -81.67, 30;...
    'Columbus OH', 40.00, -83.10, 30;...
    'Dallas TX', 32.85, -96.95, 40;...
    'Denver CO', 39.75, -105.00, 30;...
    'Detroit MI', 42.35, -83.10, 45;...
    'Fresno CA', 36.70, -119.75, 25;...
    'Houston TX', 29.80, -95.25, 30;...
    'Indianapolis IN', 39.80, -86.15, 20;...
    'Jacksonville FL', 30.45, -81.60, 25;...
    'Kansas City MO', 39.15, -94.55, 30;...
    'Knoxville TN', 35.95, -84.00, 30;... 
    'Las Vegas NV', 36.20, -115.20, 25;...
    'Los Angelos CA', 34.00, -117.90, 70;...
    'Memphis TN', 35.10, -90.10, 20;...
    'Miami FL', 26.05, -80.30, 20;...
    'Minneapolis MN', 44.95, -93.25, 30;...
    'Montreal QC', 45.60, -73.70, 30;...
    'Nashville TN', 36.20, -86.60, 30;...
    'New Orleans LA', 30.05, -90.30, 30;...
    'New York NY', 40.85, -73.70, 70;...
    'Omaha NE', 41.30, -96.05, 25;...
    'Orlando FL', 28.50, -81.30, 20;...
    'Philadelphia PA', 40.00, -75.20, 50;...
    'Phoenix AZ', 33.60, -112.00, 40;...
    'Pittsburgh PA', 40.40, -79.95, 25;... %ok
    'Portland OR', 45.45, -122.55, 30;...
    'Reno NV', 39.55, -119.70, 20;...
    'Richmond VA', 37.40, -77.30, 20;...
    'Sacramento CA', 38.65, -121.40, 25;...
    'Salt Lake City UT', 40.70, -111.95, 20;...
    'San Antonio TX', 29.55, -98.45, 30;...
    'San Diego CA', 32.80, -117.00, 25;...
    'San Francisco CA', 37.60, -122.00, 40;...
    'Seattle WA', 47.35, -122.25, 50;...
    'St Louis MO', 38.65, -90.35, 30;...
    'Tampa FL', 27.90, -82.40, 30;...
    'Toronto ON', 43.70, -79.50, 40;...
    'Tucson AZ', 32.25, -110.85, 20;...
    'Vancouver BC', 49.25, -122.85, 25;...
    'Washington DC', 39.15, -76.80, 50;... 
    'Bruce Mansfield PA', 40.40, -79.05, 20;...
    'Cholla AZ', 34.95, -110.20, 20;...
    'Colstrip MT', 45.90, -106.45, 20;...
    'Conemaugh PA', 40.10, -76.55, 20;...
    'Coronado Gen. Station AZ', 34.55, -109.20, 20;...
    'Craig CO', 40.50, -107.35, 20;...
    'Crystal River FL', 28.95, -82.65, 20;...
    'Four Corners/San Juan NM', 36.75, -108.30, 35;...
    'Gen J M Gavin OH', 40.55, -80.45, 20;...
    'Gibson IN', 37.95, -87.00, 20;...
    'Hatsfields Ferry Power Station PA', 39.85, -79.90, 20;...
    'Huntington UT', 39.25, -111.10, 20;...
    'Intermountain UT', 39.55, -112.55, 20;...
    'Jim Bridger WY', 41.75, -108.65, 20;...
    'JM Stuart OH', 39.85, -80.70, 20;...
    'Johnsonville TN', 36.05, -87.90, 20;...
    'Joppa Steam IL', 37.20, -88.75, 20;...
    'Laramie River WY', 42.10, -104.85, 20;...
    'Leland Olds ND', 47.40, -101.35, 35;...
    'Marshall NC', 35.60, -80.95, 20;...
    'Navajo Generating Station AZ', 36.90, -111.35, 20;...
    'Seminole FL', 29.80, -81.55, 20;...
    'Valmy NV', 40.90, -117.00, 20};



%These should reference variables that contain the gridded, average NO2
%columns produced by no2_column_map_2014.  Both should reference the same
%lat/lon matrices.
old_avg = NO2_2011_weekend;
new_avg = NO2_2013_weekend;
latgrid = lat;
longrid = lon;


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%   INPUT VALIDATION    %%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%Read the "cities" input array
city_names = cities(:,1);
city_lats = cell2mat(cities(:,2));
city_lons = cell2mat(cities(:,3));
city_dist = cell2mat(cities(:,4));

%Check that the lengths of the three city fields are the same.  If
%city_dist has only 1 entry, we will replicate that entry for all cities.
if numel(city_names) ~= numel(city_lats) || numel(city_names) ~= numel(city_lons) || (numel(city_dist) ~= numel(city_names) && numel(city_dist) ~= 1)
    error('City05_11:input_error','The fields referencing the cities are not all the same length.')
end

if numel(city_dist) == 1
    city_dist = repmat(city_dist,1,numel(city_names));
end


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%   BEGIN MAIN BODY     %%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

City_Data = struct('City_Name','','City_Lat',0,'City_Lon',0,'Old_Value',0,'New_Value',0,'Percent_Change',0);
City_Array = cell(numel(city_names)+1,6);
City_Array(1,1:6) = {'City_Name', 'City_Lat', 'City_Lon', 'Old_Value', 'New_Value', 'Percent Change'};

len = numel(city_names);
for a = 1:len
    fprintf('Now comparing %s\n',city_names{a});
    city_pixels = find_circular_region(city_lons(a), city_lats(a), city_dist(a), longrid, latgrid);
    city_avg_old = nanmean(old_avg(city_pixels));
    city_avg_new = nanmean(new_avg(city_pixels));
    
    percent_change = 100*(city_avg_new - city_avg_old)/city_avg_old;
    
    % Write the data to a structure, which will probably be more useful for
    % further Matlab operations.
    City_Data(a).City_Name = city_names(a);
    City_Data(a).City_Lat = city_lats(a);
    City_Data(a).City_Lon = city_lons(a);
    City_Data(a).Old_Value = city_avg_old;
    City_Data(a).New_Value = city_avg_new;
    City_Data(a).Percent_Change = percent_change;
    
    % Write the data to a cell array so that we can output the results as a
    % csv file if desired.
    
    City_Array(a+1,:) = {city_names{a}, city_lats(a), city_lons(a), city_avg_old, city_avg_new, percent_change};
end

% Ask the user if they wish to save the output file
[filename, pathname] = uiputfile('.csv', 'Save output as .csv file?','CityAvgDifferences.csv');

if filename == 0; %If the user cancels, forget saving. Otherwise...
else
    if ~strcmp(filename(end-3:end),'.csv') %Ensure that the filename ends in '.csv'
        filename = strcat(filename,'.csv');
    end
    
    savefile = fullfile(pathname,filename);
    fid = fopen(savefile,'w');
    fprintf(fid,'%s, %s, %s, %s, %s, %s\n',City_Array{1,1:6});
    for b = 2:size(City_Array,1)
        fprintf(fid,'%s, %f, %f, %g, %g, %f\n',City_Array{b,1:6});
    end
    fclose(fid);
end
